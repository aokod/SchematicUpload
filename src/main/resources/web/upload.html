<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Upload a schematic - Aedificium</title>
		<meta name="description" content="Aedificium (aedi.app) is a lightweight building server with a whole bunch of cool features.">
		<meta name="keywords" content="Aedificium,aedi,aedi.app,architecture,build,building,creative,freebuild,minecraft,server,servers">
	
		<link href="https://aedi.app/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" media="all">
		<link href="https://aedi.app/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all">
		<link href="https://aedi.app/assets/css/custom.css" rel="stylesheet" type="text/css" media="all">
		<link rel="stylesheet" href="/schem.css"/>

		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script type="text/javascript" src="https://aedi.app/assets/js/bootstrap.min.js"></script>
		<!-- SchematicUpload JS -->
		<script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.2/base64.min.js"></script>
		<script src="/uploader.js"></script>
		<script type="text/javascript">
			// Toggle accordion icons when expanded/collapsed
			$(document).ready(function() {
				$('.accordion-body').on('shown.bs.collapse', function() {
					$(this).siblings('.accordion-heading').find('.icon-angle-down').removeClass('icon-angle-down').addClass('icon-angle-up');
				});
				$('.accordion-body').on('hidden.bs.collapse', function() {
					$(this).siblings('.accordion-heading').find('.icon-angle-up').removeClass('icon-angle-up').addClass('icon-angle-down');
				});
			});
		</script>
		
		<link rel="icon" type="image/png" href="https://aedi.app/assets/img/jules-16x16.png" sizes="16x16">
		<link rel="icon" type="image/png" href="https://aedi.app/assets/img/jules-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="https://aedi.app/assets/img/jules-128x128.png" sizes="128x128">
	</head>

	<body style="zoom: 1;">
		<div class="container-fluid">
			<div class="masthead">
				<img src="https://aedi.app/assets/svg/jules.svg" onerror="this.src='https://aedi.app/assets/img/jules.png'" alt="Jules" style="float:left; height:45px">
				<h3 class="joiner">play.aedi.app</h3>
				<h3 class="muted">Aedificium</h3>
				
				<div class="navbar">
					<div class="navbar-inner">
						<div class="container">
							<ul class="nav">
								<li><a href="https://aedi.app/">Home</a></li>
								<li><a href="https://aedi.app/blog/latest">Blog</a></li>
								<li class="dropdown active">
									<a href="https://aedi.app/resources" class="dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
									<ul class="dropdown-menu">
										<li><a href="https://aedi.app/map">Dynmap® map</a></li>
										<li><a href="https://aedi.app/stats">Server statistics</a></li>
										<li class="divider"></li>
										<li class="nav-header">Forms</li>
										<li><a href="https://aedi.app/forms/banned">Appeal a ban</a></li>
										<li><a href="https://aedi.app/forms/architect">Become an architect</a></li>
										<li class="divider"></li>
										<li class="nav-header">External pages</li>
										<li><a href="https://files.aedi.app/" target="_blank">Static file server <i class="icon-external-link"></i></a></li>
										<li><a href="https://panel.aedi.app/" target="_blank">Pterodactyl® panel <i class="icon-external-link"></i></a></li>
										<li><a href="https://www.planetminecraft.com/member/aedifi" target="_blank">Planet Minecraft <i class="icon-external-link"></i></a></li>
									</ul><!-- /dropdown-menu -->
								</li><!-- /dropdown -->
								<li class="dropdown">
									<a href="#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
									<ul class="dropdown-menu">
										<li class="nav-header">Introduction</li>
										<li><a href="https://aedi.app/support">About the server</a></li>
										<li><a href="https://aedi.app/support/rules">Conduct policy</a></li>
										<li><a href="https://aedi.app/support/issues">Reporting issues</a></li>
										<li><a href="https://aedi.app/support/faq">Frequently asked questions</a></li>
										<li class="divider"></li>
										<li><a href="https://aedi.app/support">More articles »</a></li>
									</ul><!-- /dropdown-menu -->
								</li><!-- /dropdown -->
								<li><a href="https://forum.aedi.app">Forum</a></li>
							</ul><!-- /nav -->
						</div><!-- /container -->
					</div><!-- /navbar-inner -->
				</div><!-- /navbar -->

			</div><!-- /masthead -->
			<!-- Start of content -->
			<div class="content">
				<ul class="breadcrumb">
    				<li><a href="/">Index</a> <span class="divider">/</span></li>
        			<li class="active">Upload a schematic</li>
    			</ul><!-- /breadcrumb -->
				<section id="upload-schematic">
					<div class="row fluid">
						<div class="span6 upload">
							<form id="upload-form" class="form-horizontal" action="/api" enctype="multipart/form-data" method="post">
								<div class="control-group">
									<label class="control-label" for="file-upload">Choose file</label>
									<div class="controls">
										<input required id="file-upload" name="file-upload" type="file" accept=".schem,.schematic,.litematic"/>
										<label class="checkbox"><input id="show-preview" type="checkbox"> Show a preview of the schematic</label>
										<script type="module">
											import renderSchematic from '/preview/src/webschematics.js';
			
											let currentEllipsisInterval = null;
											let currentFile = null;
											
											// Set up stats event listener
											const previewStats = document.getElementById("preview-stats");
											const statsFps = document.getElementById("stats-fps");
											const statsMeshes = document.getElementById("stats-meshes");
											const statsVertices = document.getElementById("stats-vertices");
											const statsFaces = document.getElementById("stats-faces");
											
											window.addEventListener('webschematics:stats', (event) => {
												const { type, data } = event.detail;
												
												if (type === 'fps') {
													statsFps.textContent = data.fps;
													statsMeshes.textContent = data.meshes.toLocaleString();
													statsVertices.textContent = data.vertices.toLocaleString();
													statsFaces.textContent = data.faces.toLocaleString();
													previewStats.style.display = "block";
												} else if (type === 'render:complete' || type === 'render:finished') {
													// Update geometry stats when rendering completes
													statsMeshes.textContent = data.meshes.toLocaleString();
													statsVertices.textContent = data.vertices.toLocaleString();
													statsFaces.textContent = data.faces.toLocaleString();
													previewStats.style.display = "block";
												}
											});
											
											// Function to clear the preview panel (remove renderer)
											function clearPreview() {
												const previewPanel = document.getElementById("preview-panel");
												const previewText = document.getElementById("preview-text");
												
												// Remove all children except preview-text and preview-stats
												const children = Array.from(previewPanel.children);
												children.forEach(child => {
													if (child !== previewText && child !== previewStats) {
														previewPanel.removeChild(child);
													}
												});
												
												// Hide stats and show preview-text
												previewStats.style.display = "none";
												previewText.style.display = "";
											}
											
											// Function to render the schematic
											async function renderPreview(file) {
												const box = document.getElementById("show-preview");
												const previewText = document.getElementById("preview-text");
												const previewPanel = document.getElementById("preview-panel");
												
												// Clear any existing interval
												if (currentEllipsisInterval) {
													clearInterval(currentEllipsisInterval);
													currentEllipsisInterval = null;
												}
												
												// If checkbox is unchecked, clear the render and show appropriate message
												if (!box.checked) {
													clearPreview();
													if (currentFile) {
														previewText.textContent = "Check the box to show a preview of the schematic.";
													} else {
														previewText.textContent = "Choose a file to show a preview of the schematic.";
													}
													return;
												}
												
												// Reset preview-text visibility
												previewText.style.display = "";
												
												if (file && (file.name.endsWith(".schem") || file.name.endsWith(".schematic") || file.name.endsWith(".litematic"))) {
													// Clear any existing render before starting a new one
													clearPreview();
													
													const baseMessage = "<i class='icon-spinner icon-spin'></i> Loading a preview of the schematic";
													
													// Animate ellipsis (1-3 periods)
													let ellipsisCount = 0;
													currentEllipsisInterval = setInterval(() => {
														ellipsisCount = (ellipsisCount % 3) + 1;
														previewText.innerHTML = baseMessage + ".".repeat(ellipsisCount);
													}, 500);
													
													try {
														await renderSchematic(file, previewPanel,
															'https://raw.githubusercontent.com/InventivetalentDev/minecraft-assets/1.21.10');
														// Rendering complete - clear interval and hide preview-text
														if (currentEllipsisInterval) {
															clearInterval(currentEllipsisInterval);
															currentEllipsisInterval = null;
														}
														previewText.style.display = "none";
													} catch (error) {
														// On error, stop animation and show error message
														if (currentEllipsisInterval) {
															clearInterval(currentEllipsisInterval);
															currentEllipsisInterval = null;
														}
														previewText.textContent = "Error loading preview: " + error.message;
													}
												} else {
													// Reset to default message if file doesn't match
													previewText.textContent = "Choose a file to show a preview of the schematic.";
												}
											}
											
											// Handle file selection
											document.getElementById("file-upload").addEventListener("change", (event) => {
												currentFile = event.target.files[0];
												renderPreview(currentFile);
											});
											
											// Handle checkbox change
											document.getElementById("show-preview").addEventListener("change", () => {
												renderPreview(currentFile);
											});
										</script>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="input-code">In-game code</label>
									<div class="controls">
										<input required id="input-code" name="input-code" type="text"/>
									</div>
								</div>
								<div class="control-group">
									<div class="controls">
										<input type="submit" value="Upload" id="upload-button" class="btn"/>
									</div>
								</div>
								<div class="control-group">
									<div class="controls">
										<input type="text" value="" id="copy-area" style="display: none" disabled/>
									</div>
									<span id="message"></span>
								</div>
							</form><!-- /form -->
							<div class="accordion" id="upload-accordion">
								<div class="accordion-group">
									<div class="accordion-heading">
									<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapseOne">
										<i class="icon-angle-down"></i> Who can upload a schematic?
									</a>
								  </div>
								  <div id="collapseOne" class="accordion-body collapse">
									<div class="accordion-inner">
										Schematics can be uploaded by Architects and above, who have the necessary permissions to use the <code>/schematic upload</code> command.  This command generates a 6-digit code which may be entered in the above field to upload the schematic.
									</div>
								  </div>
								</div><!-- /accordion-group -->
								<div class="accordion-group">
									<div class="accordion-heading">
									<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
										<i class="icon-angle-down"></i> What kind of schematic types are supported?
									</a>
								  </div>
								  <div id="collapseTwo" class="accordion-body collapse">
									<div class="accordion-inner">
										The following schematic types are supported (according to file extension): <code>.schem</code> (1.13+), <code>.schematic</code> (up to 1.12) and <code>.litematic</code>, used by Litematica.
									</div>
								  </div>
								</div><!-- /accordion-group -->
								<div class="accordion-group">
									<div class="accordion-heading">
									<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion3" href="#collapseThree">
										<i class="icon-angle-down"></i> How does the preview feature work?
									</a>
								  </div>
								  <div id="collapseThree" class="accordion-body collapse">
									<div class="accordion-inner">
										The schematic preview feature lets you render schematics in your browser entirely using JavaScript.  It uses <code>nbt.js</code> to parse the schematic and converts block models from a resource pack into <code>three.js</code> meshes before assembling them into an interactive scene.
									</div>
								  </div>
								</div><!-- /accordion-group -->
							</div><!-- /accordion -->
						</div><!-- /span6 -->
						<div class="span6 preview">
							<div id="preview-panel">
								<p id="preview-text" class="text-center text-muted">Choose a file to show a preview of the schematic.</p>
								<div id="preview-stats" style="display: none;">
									<div class="stats-line"><span class="stats-label">FPS:</span> <span id="stats-fps">-</span></div>
									<div class="stats-line"><span class="stats-label">Meshes:</span> <span id="stats-meshes">-</span></div>
									<div class="stats-line"><span class="stats-label">Vertices:</span> <span id="stats-vertices">-</span></div>
									<div class="stats-line"><span class="stats-label">Faces:</span> <span id="stats-faces">-</span></div>
								</div>
							</div>
						</div><!-- /span6 -->
					</div><!-- /row fluid -->
				</section><!-- /upload-schematic -->
			</div><!-- /content -->
			<!-- End of content -->
			<div class="footer">
				<div class="btn-group">
					<a class="btn" href="https://aedi.app/tos">Terms</a>
					<a class="btn" href="https://aedi.app/privacy">Privacy</a>
					<a class="btn" href="mailto:aedi@murgleis.com">Contact</a>
					<a class="btn" href="https://aedi.app/sitemap">Sitemap</a>
				</div>
				<p>Copyright © 2025 Aedificium, some rights reserved.</p>
				<p>Minecraft is property of <a href="https://www.mojang.com/about/" target="_blank">Mojang Specifications <i class="icon-external-link"></i></a>.</p>
			</div><!-- /footer -->
		</div><!-- /container-fluid -->
	</body><!-- /container -->
</html>
